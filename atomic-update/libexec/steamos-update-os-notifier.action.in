#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2020-2021 Collabora Ltd.
#  Copyright © 2020-2021 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public License as
#  published by the Free Software Foundation; either version 2.1 of the License,
#  or (at your option) any later version.

set -e
set -o pipefail

opts=()
if [[ -e /run/steamos-atomupd/manifest.json ]]
then
    opts+=(--manifest /run/steamos-atomupd/manifest.json)
fi

case "$1" in
has-updates)
    opts+=(--query-only)
    if ! buildid=$(steamos-atomupd-client "${opts[@]}" | \
                   tee /dev/stderr /run/steamos-atomupd/has-updates.json | \
                   jq -erM '.minor.candidates[-1].image.buildid //empty')
    then
        rm -f /run/steamos-atomupd/has-updates.json
        echo "SteamOS is up-to-date!"
        exit 1
    fi

    echo "SteamOS $buildid is available!"
    ;;
online-updates)
    opts+=(--update-file /run/steamos-atomupd/has-updates.json)
    steamos-atomupd-client "${opts[@]}"
    jq -erM '.minor.candidates[-1].image' /run/steamos-atomupd/has-updates.json | \
    tee /dev/stderr /run/steamos-atomupd/manifest.json
    rm -f /run/steamos-atomupd/has-updates.json
    ;;
offline-updates)
    dbus-send --session --type=method_call --dest=org.kde.LogoutPrompt \
              /LogoutPrompt org.kde.LogoutPrompt.promptReboot
    touch /run/steamos/update-other
    ;;
*)
    if [[ ! "$1" ]]; then
        echo "Too few argument" >&2
    else
        echo "$1: Invalid argument" >&2
    fi
    exit 127
esac
