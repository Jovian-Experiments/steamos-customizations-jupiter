#!/bin/sh
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2020 Collabora Ltd.
#  Copyright © 2020 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public License as
#  published by the Free Software Foundation; either version 2.1 of the License,
#  or (at your option) any later version.

set -e
set -u
set -o pipefail

if [[ "$(id -u)" -ne 0 ]]; then
    echo "${0##*/}: You must run this as root" >&2
    exit 1
fi

prepare_grub_to_access_device() {
    set -- prepare_grub_to_access_device "$@"
    "$SHELL" -c '. /usr/share/grub/grub-mkconfig_lib; "$@"' "$0" "$@"
}

grubcfg() {
    cat <<EOF
#
# Automatically generated file; DO NOT EDIT.
# ${0##*/} grub.cfg
#

EOF

    device="$(grub-probe --target=device "$1")"
    prepare_grub_to_access_device "$device"

    cat <<EOF
configfile $1
EOF
}

isremovable() {
    if ! devname="$(realpath "$1")"; then
        return 1
    fi

    if ! devpath="$(realpath "/sys/class/block/${devname##*/}")"; then
        return 1
    fi

    if ! test -e "$devpath/removable"; then
        devpath="${devpath%/*}"
    fi

    if ! test -e "$devpath/removable"; then
        return 1
    fi

    grep -q 1 "$devpath/removable"
}

if isremovable @udev_symlinks_absdir@/self/rootfs; then
    GRUB_DISABLE_OS_PROBER=true
    export GRUB_DISABLE_OS_PROBER
else
    GRUB_DISABLE_EFI_PROBER=true
    export GRUB_DISABLE_EFI_PROBER
    for device in @udev_symlinks_absdir@/*/efi; do
        test -e "$device" || continue
        if uuid=$(grub-probe --target=fs_uuid --device "$device"); then
            GRUB_OS_PROBER_SKIP_LIST="${GRUB_OS_PROBER_SKIP_LIST:+$GRUB_OS_PROBER_SKIP_LIST }$uuid@/@grub_config_relpath@"
            # Deprecated grub-root.cfg and grub-var.cfg.
            GRUB_OS_PROBER_SKIP_LIST="${GRUB_OS_PROBER_SKIP_LIST:+$GRUB_OS_PROBER_SKIP_LIST }$uuid@/@grub_root_config_relpath@"
            GRUB_OS_PROBER_SKIP_LIST="${GRUB_OS_PROBER_SKIP_LIST:+$GRUB_OS_PROBER_SKIP_LIST }$uuid@/@grub_var_config_relpath@"
            export GRUB_OS_PROBER_SKIP_LIST
        fi
    done
fi

grub-mkconfig -o /tmp/grub.cfg "$@"
if echo "$*" | grep -qE "\(-o\|--output\)"; then
    exit
fi

if ! mv /tmp/grub.cfg /boot/grub/grub.cfg 2>/dev/null; then
    echo "Warning: /boot/grub/grub.cfg: Read-only file" >&2 
    mv /tmp/grub.cfg /efi/EFI/steamos/grub.cfg
    exit
fi

grubcfg /boot/grub/grub.cfg >/efi/EFI/steamos/grub.cfg
