#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2019 Collabora Ltd.
#  Copyright © 2019 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public License as
#  published by the Free Software Foundation; either version 2.1 of the License,
#  or (at your option) any later version.

set -e
set -u

FORCE=0 # --force

FACTORY_RESET_STAMPFILE=@factory_reset_stampfile@

[ -e @libdir@/steamos-partitions-lib ] && \
    . @libdir@/steamos-partitions-lib  || \
    { echo "Failed to source '@libdir@/steamos-partitions-lib'"; exit 1; }

usage() {
    local status=${1-2}

    if [ $status -ne 0 ]; then
        exec >&2
    fi

    echo
    echo "Usage: $(basename $0) [OPTIONS]"
    echo
    echo "Factory reset of SteamOS, wipe out the data partitions."
    echo
    echo "This script only configures the system to jump into the initrd"
    echo "on shutdown, and reboot. The work is done in the initrd."
    echo
    echo "OPTIONS"
    echo
    echo "  --force    Do things even when it looks unsafe. Use with caution."
    echo

    exit $status
}

ask() {
    local message="$1 [y/n] "
    local answer=

    while read -r -t 0; do
        read -n 256 -r -s
    done

    while true; do
        read -p "$message" answer
        case "$answer" in
            [Yy]|YES|Yes|yes) return 0;;
            [Nn]|NO|No|no)    return 1;;
            *) echo "Please answer yes or no.";;
        esac
    done
}

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            usage 0
            ;;
        -f|--force)
            shift
            FORCE=1
            ;;
        *)
            usage 1
            ;;
    esac
done

if ! verity_is_enabled && ! [ $FORCE -eq 1 ]; then
    echo "Factory reset is available only when dm-verity is enabled."
    echo "Use --force if you really want to proceed."
    exit 1
fi

echo
echo "You're about to perform a factory reset of your SteamOS install!"
echo
echo "The data partitions will be erased, all your personal data will be lost."
echo "Then the system will reboot, and you'll be back to a pristine SteamOS install."
echo
if ! ask "Do you want to continue?"; then
    echo "Alright buddy. Come back when you feel ready."
    exit 0
fi

touch /run/initramfs/.need_shutdown
touch $FACTORY_RESET_STAMPFILE
reboot
