#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2020-2021 Collabora Ltd.
#  Copyright © 2020-2021 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public License as
#  published by the Free Software Foundation; either version 2.1 of the License,
#  or (at your option) any later version.

set -e
set -u
set -o pipefail

usage() {
    cat <<EOF
Usage: ${0##*/} enable|disable|status

Enable or disable read-only on the current running SteamOS.
EOF
}

cleanup() {
    ret="$?"
    trap - 0

    if [[ "$ret" -ne 0 ]]
    then
        if [[ -e /efi/@grub_config_relpath@.bak ]]
        then
            mv /efi/@grub_config_relpath@{.bak,}
        fi
    fi

    rm -f /efi/@grub_config_relpath@.bak
}

backup() {
    trap cleanup 0
    mv /efi/@grub_config_relpath@{,.bak}
}

read_write() {
    backup

    if mountpoint -q /boot
    then
        umount /boot
    fi
    mkdir -p /var/boot/grub
    GRUB_DISABLE_STEAMOS_VERITY=true update-grub
    tune2fs -O ^read-only "$1"
    mount -o remount,rw /
    rm -Rf /var/boot/
    sync /
}

read_only() {
    if tune2fs -l "$1" | grep -q '^Filesystem features: .*read-only.*$'
    then
        echo "Warning: The rootfs is already read-only!" >&2
        echo "         Nothing is performed." >&2
        return
    fi

    backup

    if mountpoint -q /boot
    then
        umount /boot
    fi
    sync /
    mount -o remount,ro /
    tune2fs -O read-only "$1"
    rm -Rf /var/boot/
    GRUB_DISABLE_STEAMOS_VERITY=true update-grub
}

status() {
    local filesystem_is_readonly
    local device_is_readonly
    local roothash

    if tune2fs -l "$1" | grep -q '^Filesystem features: .*read-only.*$'
    then
        echo "enabled"
        return
    else
        echo "disabled"
        return 1
    fi
}

case "${1:-}" in
    disable)
        read_write @udev_symlinks_absdir@/self/rootfs
        ;;
    enable)
        read_only @udev_symlinks_absdir@/self/rootfs
        ;;
    status)
        status @udev_symlinks_absdir@/self/rootfs
        ;;
    *)
        usage
        exit 1
esac
