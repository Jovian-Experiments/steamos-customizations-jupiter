#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2019 Collabora Ltd.
#  Copyright © 2019 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or modify
#  it under the terms of the GNU Lesser General Public License as published
#  by the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

set -e
set -u

USERNAME=steamos
ADDITIONAL_GROUPS='adm sudo'

make_steamos_user() {
    adduser $USERNAME --gecos "" --disabled-password --add_extra_groups
    for group in $ADDITIONAL_GROUPS; do
        getent group $group >/dev/null || continue
        addgroup $USERNAME $group
    done
    echo "$USERNAME:$USERNAME" | chpasswd
}

make_steamos_homedir() {
    if command -v mkhomedir_helper >/dev/null; then
        mkhomedir_helper $USERNAME
    else
        mkdir -p /home/$USERNAME
        cp -r /etc/skel/. /home/$USERNAME
        chown -R $USERNAME:$USERNAME /home/$USERNAME
    fi
}

enable_ls_aliases() {
    [ -e /home/$USERNAME/.bashrc ] || return
    sed -i \
        -e '/alias ll=/s/^#\s*//' \
        -e '/alias la=/s/^#\s*//' \
        /home/$USERNAME/.bashrc
}

if ! id -u $USERNAME >/dev/null 2>&1; then
    echo >&2 "Creating user '$USERNAME'"
    make_steamos_user
    enable_ls_aliases
else
    echo >&2 "User '$USERNAME' already exists!"
    if ! [ -d /home/$USERNAME ]; then
        echo >&2 "Homedir for '$USERNAME' is missing, creating it now"
        make_steamos_homedir
        enable_ls_aliases
    fi
fi
