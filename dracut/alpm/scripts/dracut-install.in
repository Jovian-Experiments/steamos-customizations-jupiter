#!/bin/bash -e

declare -A kern
all=0

while read -r line; do
    if [[ $line != */vmlinuz ]]; then
        # triggers when it's a change to usr/lib/dracut/modules.d/*
        all=1
        continue
    fi

    if ! read -r pkgbase > /dev/null 2>&1 < "${line%/vmlinuz}/pkgbase"; then
        # if the kernel has no pkgbase, we skip it
        continue
    fi

    # always install the kernel
    install -Dm644 "${line}" "/boot/vmlinuz-${pkgbase}"

    # compound args for each kernel
    kver="${line%/*}"
    kver="${kver##*/}"
    kern["${pkgbase}"]="$kver"
done

if (( all )) && compgen -G usr/lib/modules/"*"/vmlinuz > /dev/null; then
    unset kern
    declare -A kern
    while read -r line; do
    	if ! read -r pkgbase > /dev/null 2>&1 < "${line%/vmlinuz}/pkgbase"; then
    	    # if the kernel has no pkgbase, we skip it
    	    continue
    	fi

    	kver="${line%/*}"
    	kver="${kver##*/}"
    	kern["${pkgbase}"]="$kver"
    done < <(compgen -G usr/lib/modules/"*"/vmlinuz)
fi

for pkgbase in "${!kern[@]}"; do
    dracut --force --hostonly --persistent-policy by-partuuid "/boot/initramfs-$pkgbase.img" "${kern[$pkgbase]}"
    dracut --force --no-hostonly --persistent-policy by-partuuid "/boot/initramfs-$pkgbase-fallback.img" "${kern[$pkgbase]}"
done
