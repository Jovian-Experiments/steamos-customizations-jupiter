#!/bin/bash

set -e

while read -r line; do
    if ! read -r pkgbase > /dev/null 2>&1 < "${line%/vmlinuz}/pkgbase"; then
        # if the kernel has no pkgbase, we skip it
        continue
    fi

    kver="${line%/*}"
    kver="${kver##*/}"
    dracut --force --hostonly "/boot/initramfs-$pkgbase.img" "$kver"
    dracut --force --no-hostonly "/boot/initramfs-$pkgbase-fallback.img" "$kver"
done < <(compgen -G /usr/lib/modules/"*"/vmlinuz)
