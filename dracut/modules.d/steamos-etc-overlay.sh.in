#!/bin/sh
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2019-2020 Collabora Ltd.
#  Copyright © 2019-2020 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or modify
#  it under the terms of the GNU Lesser General Public License as published
#  by the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

# Mount the etc overlay for steamos atomic
#
# Mount the /etc overlay now (that is, in the initrd), which is needed for
# systemd to successfully commit a generated machine-id on the very first
# boot, and to find this existing machine-id on subsequent boots.
#
# Since the overlay is defined in `/etc/fstab`, one could try to add the
# option `x-initrd.mount`, and let things happen automatically, right?
#
# Well, no, for two reasons. One is that we need to make sure that the
# various directories used for the overlay (upper and work dir) exist,
# which is not the case for a first boot scenario.
#
# Another reason is that, even though systemd-fstab-generator is smart enough
# to prefix the mountpoints found in fstab with `/sysroot`, I don't think
# it's smart enough to do the same with the overlay options `upperdir=`,
# `workdir=` and so on.
#
# For these reasons, we do the job manually here.

ETC_OVERLAY_ABSDIR=@etc_overlay_absdir@

. /lib/dracut-lib.sh

prepare_etc_overlay() {

    # Prepare the directories needed for the /etc overlay

    local sysroot="$NEWROOT"
    local overlaydir="$ETC_OVERLAY_ABSDIR"
    local upperdir="${sysroot}${overlaydir}/upper"
    local workdir="${sysroot}${overlaydir}/work"
    local dir=

    # upper dir contains persistent data, create it only if it doesn't exist
    dir="$upperdir"
    if ! [ -d "$dir" ]; then
        echo "Creating overlay upper directory '$dir'"
        rm -fr "$dir"
        mkdir -p "$dir"
    fi

    # work dir must exist and be empty
    dir="$workdir"
    rm -fr "$dir"
    mkdir -p "$dir"
}

mount_etc_overlay() {

    # Mount the /etc overlay

    local sysroot="$NEWROOT"
    local overlaydir="$ETC_OVERLAY_ABSDIR"
    local lowerdir="${sysroot}/etc"
    local upperdir="${sysroot}${overlaydir}/upper"
    local workdir="${sysroot}${overlaydir}/work"

    info "Mounting $lowerdir"
    mount -v \
        -t overlay \
        -o lowerdir=$lowerdir,upperdir=$upperdir,workdir=$workdir \
        overlay \
        $lowerdir 2>&1 | vinfo

    if ! ismounted "$lowerdir"; then
        warn "Mounting $lowerdir failed! Compile the kernel with CONFIG_OVERLAY_FS!"
        warn "*** Dropping you to a shell; the system will continue"
        warn "*** when you leave the shell."
        emergency_shell
    fi
}

NOOVERLAY=$(getarg 'rd.steamos.nooverlay')
if [ -n "$NOOVERLAY" ]; then
    warn "/etc overlay not mounted."
    exit 0
fi
prepare_etc_overlay
mount_etc_overlay
