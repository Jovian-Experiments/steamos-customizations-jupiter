#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# vim: et sts=4 sw=4

#  SPDX-License-Identifier: LGPL-2.1+
#
#  Copyright © 2021 Collabora Ltd.
#  Copyright © 2021 Valve Corporation.
#
#  This file is part of steamos-customizations.
#
#  steamos-customizations is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public License as
#  published by the Free Software Foundation; either version 2.1 of the License,
#  or (at your option) any later version.

get_efivar_str() {
    dd bs=1 skip=4 status=none "if=$1" | iconv -t ASCII -f UTF-16 | tr '\0' '\n'
}

for i in /sys/firmware/efi/efivars/*LoaderDevicePartUUID-*
do
    [[ -e "$i" ]] || continue

    partuuid="$(get_efivar_str /dev/stdin <"$i")"
    [[ "$partuuid" ]] || continue

    # XXX: Technically speaking this is not required, although ...
    #
    # When using dracut --no-hostonly initrd, the wait_for_dev is completely
    # unreliable. It will immediatelly return, even when the device in question
    # is not populated.
    # At the same time, having a seemingly unused instance here progs its
    # machinery to actually get the device ready for the actual work, during
    # mounting.
    #
    # In other words - wait_for_dev is unreliable, but we need this hack here or
    # the mount (in steamos-root.sh.in) will fail.
    partuuid="${partuuid,,}"
    wait_for_dev "/dev/disk/by-partuuid/$partuuid"
done
